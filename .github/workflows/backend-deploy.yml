name: Deploy Backend to Render

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: json, curl, mysqli, pdo
        tools: composer
    
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        if [ -f composer.json ]; then
          composer install --no-dev --optimize-autoloader
          echo "âœ… Composer dependencies installed"
        else
          echo "â„¹ï¸ No composer.json found, skipping dependency installation"
        fi
    
    - name: Run tests before deploy
      run: |
        echo "ğŸ§ª Running pre-deployment tests..."
        
        # Test PHP syntax
        php -l index.php
        
        # Start server for testing
        php -S localhost:8000 index.php &
        sleep 3
        
        # Test critical endpoints
        curl -f http://localhost:8000/ || echo "Main endpoint test failed"
        
        echo "âœ… Pre-deployment tests completed"
    
    - name: Prepare deployment
      run: |
        echo "ğŸš€ Preparing deployment..."
        
        # Create deployment info
        echo "<?php" > deploy_info.php
        echo "// Deployment info" >> deploy_info.php
        echo "define('DEPLOY_TIME', '$(date)');" >> deploy_info.php
        echo "define('DEPLOY_COMMIT', '${{ github.sha }}');" >> deploy_info.php
        echo "define('DEPLOY_BRANCH', '${{ github.ref_name }}');" >> deploy_info.php
        
        echo "âœ… Deployment prepared"
    
    - name: Deploy to Render
      run: |
        echo "ğŸš€ Deploying to Render..."
        echo "Render will automatically deploy when changes are pushed to main branch"
        echo "âœ… Deployment triggered"
        
        # In a real scenario, you might use Render's API or webhook
        # For now, Render auto-deploys from GitHub
    
    - name: Create deployment comment
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: 'ğŸš€ Backend deployed successfully to Render!\n\n' +
                  'ğŸ“Š Check your Render dashboard for deployment status.\n' +
                  'ğŸ”— API will be available at your Render URL.\n' +
                  'â° Deployment time: ' + new Date().toISOString()
          })